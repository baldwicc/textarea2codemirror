!function(a){"object"==typeof exports&&"object"==typeof module?a(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],a):a(CodeMirror)}(function(a){"use strict";function b(a,b){this.mv=a,this.type=b,this.classes="left"==b?{chunk:"CodeMirror-merge-l-chunk",start:"CodeMirror-merge-l-chunk-start",end:"CodeMirror-merge-l-chunk-end",insert:"CodeMirror-merge-l-inserted",del:"CodeMirror-merge-l-deleted",connect:"CodeMirror-merge-l-connect"}:{chunk:"CodeMirror-merge-r-chunk",start:"CodeMirror-merge-r-chunk-start",end:"CodeMirror-merge-r-chunk-end",insert:"CodeMirror-merge-r-inserted",del:"CodeMirror-merge-r-deleted",connect:"CodeMirror-merge-r-connect"}}function c(b){b.diffOutOfDate&&(b.diff=p(b.orig.getValue(),b.edit.getValue()),b.diffOutOfDate=!1,a.signal(b.edit,"updateDiff",b.diff))}function d(a){function b(b){"full"==b&&(a.svg&&w(a.svg),w(a.copyButtons),i(a.edit,g.marked,a.classes),i(a.orig,h.marked,a.classes),g.from=g.to=h.from=h.to=0),c(a),a.showDifferences&&(j(a.edit,a.diff,g,DIFF_INSERT,a.classes),j(a.orig,a.diff,h,DIFF_DELETE,a.classes)),l(a)}function d(a){clearTimeout(f),f=setTimeout(b,1==a?250:100)}function e(){a.diffOutOfDate||(a.diffOutOfDate=!0,g.from=g.to=h.from=h.to=0),d(!0)}var f,g={from:0,to:0,marked:[]},h={from:0,to:0,marked:[]};return a.edit.on("change",e),a.orig.on("change",e),a.edit.on("markerAdded",d),a.edit.on("markerCleared",d),a.orig.on("markerAdded",d),a.orig.on("markerCleared",d),a.edit.on("viewportChange",d),a.orig.on("viewportChange",d),b(),b}function e(a){a.edit.on("scroll",function(){f(a,DIFF_INSERT)&&l(a)}),a.orig.on("scroll",function(){f(a,DIFF_DELETE)&&l(a)})}function f(a,b){if(a.diffOutOfDate)return!1;if(!a.lockScroll)return!0;var c,d,e=+new Date;if(b==DIFF_INSERT?(c=a.edit,d=a.orig):(c=a.orig,d=a.edit),c.state.scrollSetBy==a&&(c.state.scrollSetAt||0)+50>e)return!1;var f,h,i=c.getScrollInfo(),j=.5*i.clientHeight,k=i.top+j,l=c.lineAtHeight(k,"local"),m=u(a.diff,l,b==DIFF_INSERT),n=g(c,b==DIFF_INSERT?m.edit:m.orig),o=g(d,b==DIFF_INSERT?m.orig:m.edit),p=(k-n.top)/(n.bot-n.top),q=o.top-j+p*(o.bot-o.top);if(q>i.top&&(h=i.top/j)<1)q=q*h+i.top*(1-h);else if((f=i.height-i.clientHeight-i.top)<j){var r=d.getScrollInfo(),s=r.height-r.clientHeight-q;s>f&&(h=f/j)<1&&(q=q*h+(r.height-r.clientHeight-f)*(1-h))}return d.scrollTo(i.left,q),d.state.scrollSetAt=e,d.state.scrollSetBy=a,!0}function g(a,b){var c=b.after;return null==c&&(c=a.lastLine()+1),{top:a.heightAtLine(b.before||0,"local"),bot:a.heightAtLine(c,"local")}}function h(a,b,c){a.lockScroll=b,b&&0!=c&&f(a,DIFF_INSERT)&&l(a),a.lockButton.innerHTML=b?"⇛⇚":"⇛&nbsp;&nbsp;⇚"}function i(b,c,d){for(var e=0;e<c.length;++e){var f=c[e];f instanceof a.TextMarker?f.clear():f.parent&&(b.removeLineClass(f,"background",d.chunk),b.removeLineClass(f,"background",d.start),b.removeLineClass(f,"background",d.end))}c.length=0}function j(a,b,c,d,e){var f=a.getViewport();a.operation(function(){c.from==c.to||f.from-c.to>20||c.from-f.to>20?(i(a,c.marked,e),k(a,b,d,c.marked,f.from,f.to,e),c.from=f.from,c.to=f.to):(f.from<c.from&&(k(a,b,d,c.marked,f.from,c.from,e),c.from=f.from),f.to>c.to&&(k(a,b,d,c.marked,c.to,f.to,e),c.to=f.to))})}function k(a,b,c,d,e,f,g){function h(b,c){for(var h=Math.max(e,b),i=Math.min(f,c),j=h;i>j;++j){var k=a.addLineClass(j,"background",g.chunk);j==b&&a.addLineClass(k,"background",g.start),j==c-1&&a.addLineClass(k,"background",g.end),d.push(k)}b==c&&h==c&&i==c&&(h?d.push(a.addLineClass(h-1,"background",g.end)):d.push(a.addLineClass(h,"background",g.start)))}for(var i=D(0,0),j=D(e,0),k=a.clipPos(D(f-1)),l=c==DIFF_DELETE?g.del:g.insert,m=0,n=0;n<b.length;++n){var o=b[n],p=o[0],q=o[1];if(p==DIFF_EQUAL){var r=i.line+(t(b,n)?0:1);z(i,q);var u=i.line+(s(b,n)?1:0);u>r&&(n&&h(m,r),m=u)}else if(p==c){var v=z(i,q,!0),w=B(j,i),x=A(k,v);C(w,x)||d.push(a.markText(w,x,{className:l})),i=v}}m<=i.line&&h(m,i.line+1)}function l(a){if(a.showDifferences){if(a.svg){w(a.svg);var b=a.gap.offsetWidth;x(a.svg,"width",b,"height",a.gap.offsetHeight)}w(a.copyButtons);var c="left"==a.type,d=a.edit.getViewport(),e=a.orig.getViewport(),f=a.edit.getScrollInfo().top,g=a.orig.getScrollInfo().top;q(a.diff,function(h,i,j,k){if(!(j>d.to||k<d.from||h>e.to||i<e.from)){var l=a.orig.heightAtLine(h,"local")-g,m=l;if(a.svg){var n=a.edit.heightAtLine(j,"local")-f;if(c){var o=l;l=n,n=o}var p=a.orig.heightAtLine(i,"local")-g,q=a.edit.heightAtLine(k,"local")-f;if(c){var o=p;p=q,q=o}var r=" C "+b/2+" "+n+" "+b/2+" "+l+" "+(b+2)+" "+l,s=" C "+b/2+" "+p+" "+b/2+" "+q+" -1 "+q;x(a.svg.appendChild(document.createElementNS(E,"path")),"d","M -1 "+n+r+" L "+(b+2)+" "+p+s+" z","class",a.classes.connect)}var t=a.copyButtons.appendChild(v("div","left"==a.type?"⇝":"⇜","CodeMirror-merge-copy"));t.title="Revert chunk",t.chunk={topEdit:j,botEdit:k,topOrig:h,botOrig:i},t.style.top=m+"px"}})}}function m(a,b){a.diffOutOfDate||a.edit.replaceRange(a.orig.getRange(D(b.topOrig,0),D(b.botOrig,0)),D(b.topEdit,0),D(b.botEdit,0))}function n(b){var c=b.lockButton=v("div",null,"CodeMirror-merge-scrolllock");c.title="Toggle locked scrolling";var d=v("div",[c],"CodeMirror-merge-scrolllock-wrap");a.on(c,"click",function(){h(b,!b.lockScroll)}),b.copyButtons=v("div",null,"CodeMirror-merge-copybuttons-"+b.type),a.on(b.copyButtons,"click",function(a){var c=a.target||a.srcElement;c.chunk&&m(b,c.chunk)});var e=[b.copyButtons,d],f=document.createElementNS&&document.createElementNS(E,"svg");return f&&!f.createSVGRect&&(f=null),b.svg=f,f&&e.push(f),b.gap=v("div",e,"CodeMirror-merge-gap")}function o(a){return"string"==typeof a?a:a.getValue()}function p(a,b){var c=G.diff_main(a,b);G.diff_cleanupSemantic(c);for(var d=0;d<c.length;++d){var e=c[d];e[1]?d&&c[d-1][0]==e[0]&&(c.splice(d--,1),c[d][1]+=e[1]):c.splice(d--,1)}return c}function q(a,b){for(var c=0,d=0,e=D(0,0),f=D(0,0),g=0;g<a.length;++g){var h=a[g],i=h[0];if(i==DIFF_EQUAL){var j=t(a,g)?0:1,k=e.line+j,l=f.line+j;z(e,h[1],null,f);var m=s(a,g)?1:0,n=e.line+m,o=f.line+m;n>k&&(g&&b(d,l,c,k),c=n,d=o)}else z(i==DIFF_INSERT?e:f,h[1])}(c<=e.line||d<=f.line)&&b(d,f.line+1,c,e.line+1)}function r(a){c(a);var b=[];return q(a.diff,function(a,c,d,e){b.push({origFrom:a,origTo:c,editFrom:d,editTo:e})}),b}function s(a,b){if(b==a.length-1)return!0;var c=a[b+1][1];return 1==c.length||10!=c.charCodeAt(0)?!1:b==a.length-2?!0:(c=a[b+2][1],c.length>1&&10==c.charCodeAt(0))}function t(a,b){if(0==b)return!0;var c=a[b-1][1];return 10!=c.charCodeAt(c.length-1)?!1:1==b?!0:(c=a[b-2][1],10==c.charCodeAt(c.length-1))}function u(a,b,c){var d,e,f,g;return q(a,function(a,h,i,j){var k=c?i:a,l=c?j:h;null==e&&(k>b?(e=i,g=a):l>b&&(e=j,g=h)),b>=l?(d=j,f=h):b>=k&&(d=i,f=a)}),{edit:{before:d,after:e},orig:{before:f,after:g}}}function v(a,b,c,d){var e=document.createElement(a);if(c&&(e.className=c),d&&(e.style.cssText=d),"string"==typeof b)e.appendChild(document.createTextNode(b));else if(b)for(var f=0;f<b.length;++f)e.appendChild(b[f]);return e}function w(a){for(var b=a.childNodes.length;b>0;--b)a.removeChild(a.firstChild)}function x(a){for(var b=1;b<arguments.length;b+=2)a.setAttribute(arguments[b],arguments[b+1])}function y(a,b){b||(b={});for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}function z(a,b,c,d){for(var e=c?D(a.line,a.ch):a,f=0;;){var g=b.indexOf("\n",f);if(-1==g)break;++e.line,d&&++d.line,f=g+1}return e.ch=(f?0:e.ch)+(b.length-f),d&&(d.ch=(f?0:d.ch)+(b.length-f)),e}function A(a,b){return(a.line-b.line||a.ch-b.ch)<0?a:b}function B(a,b){return(a.line-b.line||a.ch-b.ch)>0?a:b}function C(a,b){return a.line==b.line&&a.ch==b.ch}var D=a.Pos,E="http://www.w3.org/2000/svg";b.prototype={constructor:b,init:function(b,c,f){this.edit=this.mv.edit,this.orig=a(b,y({value:c,readOnly:!0},y(f))),this.diff=p(o(c),o(f.value)),this.diffOutOfDate=!1,this.showDifferences=f.showDifferences!==!1,this.forceUpdate=d(this),h(this,!0,!1),e(this)},setShowDifferences:function(a){a=a!==!1,a!=this.showDifferences&&(this.showDifferences=a,this.forceUpdate("full"))}};var F=a.MergeView=function(c,d){if(!(this instanceof F))return new F(c,d);var e=d.origLeft,f=null==d.origRight?d.orig:d.origRight,g=null!=e,h=null!=f,i=1+(g?1:0)+(h?1:0),j=[],k=this.left=null,m=this.right=null;if(g){k=this.left=new b(this,"left");var o=v("div",null,"CodeMirror-merge-pane");j.push(o),j.push(n(k))}var p=v("div",null,"CodeMirror-merge-pane");if(j.push(p),h){m=this.right=new b(this,"right"),j.push(n(m));var q=v("div",null,"CodeMirror-merge-pane");j.push(q)}(h?q:p).className+=" CodeMirror-merge-pane-rightmost",j.push(v("div",null,null,"height: 0; clear: both;"));var r=this.wrap=c.appendChild(v("div",j,"CodeMirror-merge CodeMirror-merge-"+i+"pane"));this.edit=a(p,y(d)),k&&k.init(o,e,d),m&&m.init(q,f,d);var s=function(){k&&l(k),m&&l(m)};a.on(window,"resize",s);var t=setInterval(function(){for(var b=r.parentNode;b&&b!=document.body;b=b.parentNode);b||(clearInterval(t),a.off(window,"resize",s))},5e3)};F.prototype={constuctor:F,editor:function(){return this.edit},rightOriginal:function(){return this.right&&this.right.orig},leftOriginal:function(){return this.left&&this.left.orig},setShowDifferences:function(a){this.right&&this.right.setShowDifferences(a),this.left&&this.left.setShowDifferences(a)},rightChunks:function(){return this.right&&r(this.right)},leftChunks:function(){return this.left&&r(this.left)}};var G=new diff_match_patch});